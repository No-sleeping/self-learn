## 虚拟机

### 什么是虚拟化

虚拟化（英语：Virtualization）是一种资源管理技术，就是用来把物理资源（服务器，网络，硬件，CPU）进行隔离（分离）的一种技术。打破了物理资源不可分割障碍。

<br/>

### 虚拟机是怎么工作的

hypervisors的软件可以分割物理资源。这款软件可以安装在os上或者直接安装在硬件上，其中后者是企业中最常见的方式。分割后的物理资源可以被虚拟环境所用。

每一份被分割后的资源也被被叫做虚拟机，并且能够单独运行文件系统，可以在电脑之间相互转移，并且打开的时候和之前操作的是一致的。

当这个虚拟环境已经跑起来之后，用户或者一个程序提交一个增加资源的请求后，hypervisor 将请求中提交到物理系统并缓存更改。


![](https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2020/7/8/1732e388abefdce2~tplv-t2oaga2asx-watermark.awebp)

<br/>

### 虚拟机优势

虚拟机可减少在服务器设备上的支出，可以利用一个物理服务器资源切分成多个独立的虚拟机来完成许多工作。

由于只有一台主机，因此可以利用虚拟机管理程序的集中功能高效地管理所有虚拟环境。这些系统完全相互独立，这意味着你可以在不同的虚拟机里安装不同的系统环境。

<br/>

### 虚拟机劣势

虚拟机可能占用主机的大量系统资源，虚拟机的大小为数GB。在虚拟服务器上运行单个应用程序意味着还要运行**Guest OS**以及Guest OS运行所需的所有硬件的虚拟副本。这样很快就增加了很多RAM和CPU资源消耗。


迁移虚拟机上运行的应用程序的过程也可能很复杂，因为它始终附加在操作系统上。因此，必须同时迁移应用程序和操作系统。同样，在创建虚拟机时，系统管理程序会分配专用于VM的硬件资源。

<br/>

## 容器

### 什么是容器

容器是一个不依赖于操作系统，运行应用程序的环境。它通过Linux的`Namespaces`和`Cgroups`技术对应用程序进程进行隔离和限制的，**Namespace**的作用是隔离，它让应用进程只能看到该**Namespace**内的世界；而**Cgroups **的作用是限制分配给进程的宿主机资源。但对于宿主机来说，这些被“隔离”了的进程跟其他进程并没有太大区别。

容器只是运行在宿主机上的一种特殊的进程，多个容器之间使用的还是同一个宿主机的操作系统内核。

<br/>

### 容器是怎么工作的

![](https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2020/7/8/1732e388abd14d42~tplv-t2oaga2asx-watermark.awebp)

<br/>

容器 = cgroup + namespace + rootfs + 容器引擎

Cgroup： 资源控制
namespace： 访问隔离
rootfs：文件系统隔离。镜像的本质就是一个rootfs文件
容器引擎：生命周期控制

**Namespace**的作用是隔离，它让应用进程只能看到该Namespace内的世界；

而**Cgroups**的作用是限制，它给这个世界围上了一圈看不见的墙。

通过Mount Namespace可以修改容器进程对自己的文件系统 "挂载点"的认知。在容器进程启动之前重新挂载它的整个根目录"/"（通过pivot_root系统调用改变进程的文件系统，如果系统不支持，则使用chroot），而由于Mount Namespace的存在，这个挂载对宿主机不可见的。

这个挂载在容器根目录上、用来为容器进程提供隔离后执行环境的文件系统，就是所谓的“容器镜像”。它还有一个更为专业的名字，叫作：rootfs（根文件系统）。rootfs只是一个操作系统所包含的文件、配置和目录，并不包括操作系统内核。
所以说，rootfs 只包括了操作系统的 "躯壳"，并没有包括操作系统的内核。同一台机器上的所有容器，都共享宿主机操作系统的内核。


这就意味着，如果容器里的应用程序需要配置内核参数、跟内核进行直接的交互，这些都是操作的宿主机操作系统的内核，它对于该机器上的所有容器来说是一个“全局变量”，牵一发而动全身。这也是容器相比于虚拟机的主要缺陷之一：毕竟虚拟机有模拟出来的硬件机器充当沙盒，而且每个虚拟机里还运行着一个完整Guest OS让应用随便折腾。

不过由于rootfs里打包的不只是应用，而是整个操作系统的文件和目录，也就意味着，应用以及它运行所需要的所有依赖，都被封装在了一起。这就赋予了容器所谓的一致性：无论在本地、云端，还是在一台任何地方的机器上，用户只需要解压打包好的容器镜像，那么这个应用运行所需要的完整的执行环境就被重现出来。

<br/>

### 容器优势

容器占用的大小比虚拟机小很多，甚至可以小到10MB，可以轻松限制容器的内存和CPU使用率。与部署应用需要部署整个操作系统的虚拟机相比，容器非常轻巧且启动迅速。这样让我们可以快速扩展容器并添加相同的容器。


同样，容器对于持续集成和持续部署（CI / CD）实施也是极好的选择。他们通过在开发人员之间分发和合并镜像来促进协作开发。

<br/>

#### 容器劣势

容器仍无法提供与虚拟机相同的安全性和稳定性。由于它们共享主机的内核，因此不能像虚拟机一样完全隔离。


容器是进程级的隔离，一个容器可以通过影响宿主机内核的稳定性来影响其他容器。


一旦容器执行了任务，它就会关闭并删除其中的所有数据。如果希望数据保留下来，则必须使用"数据卷"进行保存，这需要在主机上进行手动配置。

<br/>

***

参考：

https://www.redhat.com/en/topics/virtualization/what-is-virtualization（What is virtualization?）

https://juejin.cn/post/6847902222148173831   （容器和虚拟机到底有啥区别？）
